<!DOCTYPE html>
<html lang="es">
<head>
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sistema de Asistencia con c贸digo QR">
  <meta name="theme-color" content="#2563eb">
  <title>Sistema Asistencia QR</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Iconos SVG simples
    const Icons = {
      Camera: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
      QrCode: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
      Users: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
      LogIn: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>,
      LogOut: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
      Coffee: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>,
      X: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      Settings: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m5.196-15.804l-4.243 4.243m-5.658 5.658l-4.242 4.242m15.804 0l-4.243-4.242m-5.658-5.658l-4.242-4.243"/></svg>,
      Download: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
      UserPlus: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
      MapPin: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
      Upload: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
    };

    // Storage Simple (IndexedDB wrapper)
    const storage = {
      async get(key) {
        try {
          const value = localStorage.getItem(key);
          return value ? { value } : null;
        } catch (error) {
          return null;
        }
      },
      async set(key, value) {
        try {
          localStorage.setItem(key, value);
          return { key, value };
        } catch (error) {
          return null;
        }
      }
    };

    window.storage = storage;

    const App = () => {
      const [workers, setWorkers] = useState([]);
      const [records, setRecords] = useState([]);
      const [activeView, setActiveView] = useState('dashboard');
      const [selectedWorker, setSelectedWorker] = useState(null);
      const [scanMode, setScanMode] = useState(null);
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const [cameraActive, setCameraActive] = useState(false);
      const [googleConfig, setGoogleConfig] = useState({
        apiKey: '',
        spreadsheetId: '',
        configured: false
      });

      useEffect(() => {
        loadData();
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('sw.js');
        }
      }, []);

      const loadData = async () => {
        try {
          const workersData = await storage.get('workers-data');
          const recordsData = await storage.get('records-data');
          const configData = await storage.get('google-config');
          
          if (workersData) setWorkers(JSON.parse(workersData.value));
          if (recordsData) setRecords(JSON.parse(recordsData.value));
          if (configData) setGoogleConfig(JSON.parse(configData.value));
        } catch (error) {
          console.log('Iniciando con datos vac铆os');
        }
      };

      const saveData = async (newWorkers, newRecords) => {
        try {
          await storage.set('workers-data', JSON.stringify(newWorkers || workers));
          await storage.set('records-data', JSON.stringify(newRecords || records));
        } catch (error) {
          console.error('Error guardando datos:', error);
        }
      };

      const saveConfig = async (config) => {
        try {
          await storage.set('google-config', JSON.stringify(config));
          setGoogleConfig(config);
        } catch (error) {
          console.error('Error guardando configuraci贸n:', error);
        }
      };

      const getLocation = () => {
        return new Promise((resolve) => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                resolve({
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
                });
              },
              () => resolve(null)
            );
          } else {
            resolve(null);
          }
        });
      };

      const addWorker = async (workerData) => {
        const newWorker = {
          id: Date.now().toString(),
          ...workerData,
          qrCode: `QR-${Date.now()}`,
          createdAt: new Date().toISOString()
        };
        const updated = [...workers, newWorker];
        setWorkers(updated);
        await saveData(updated, records);
        return newWorker;
      };

      const registerAttendance = async (workerId, type, photo) => {
        const loc = await getLocation();
        const worker = workers.find(w => w.id === workerId);
        
        const record = {
          id: Date.now().toString(),
          workerId,
          workerName: worker.name,
          type,
          timestamp: new Date().toISOString(),
          location: loc,
          photo
        };

        const updated = [...records, record];
        setRecords(updated);
        await saveData(workers, updated);

        if (googleConfig.configured) {
          await sendToGoogleSheets(record);
        }

        return record;
      };

      const sendToGoogleSheets = async (record) => {
        if (!googleConfig.configured) return;

        try {
          const date = new Date(record.timestamp);
          const values = [[
            record.workerName,
            record.type === 'entry' ? 'Entrada' : 
            record.type === 'exit' ? 'Salida' :
            record.type === 'lunch_start' ? 'Inicio Colaci贸n' : 'Fin Colaci贸n',
            date.toLocaleDateString('es-CL'),
            date.toLocaleTimeString('es-CL'),
            record.location?.lat || 'N/A',
            record.location?.lng || 'N/A',
            `https://maps.google.com/?q=${record.location?.lat},${record.location?.lng}`
          ]];

          const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${googleConfig.spreadsheetId}/values/Registros!A:G:append?valueInputOption=RAW&key=${googleConfig.apiKey}`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ values })
            }
          );

          if (!response.ok) {
            throw new Error('Error al enviar a Google Sheets');
          }
        } catch (error) {
          console.error('Error en Google Sheets:', error);
          alert('Error al sincronizar con Google Sheets');
        }
      };

      const calculateHours = (workerId) => {
        const workerRecords = records
          .filter(r => r.workerId === workerId)
          .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        let totalHours = 0;
        let totalLunchTime = 0;
        let extraHours = 0;
        
        let currentEntry = null;
        let currentLunchStart = null;

        for (const record of workerRecords) {
          const time = new Date(record.timestamp);

          if (record.type === 'entry') {
            currentEntry = time;
          } else if (record.type === 'lunch_start' && currentEntry) {
            currentLunchStart = time;
          } else if (record.type === 'lunch_end' && currentLunchStart) {
            const lunchMinutes = (time - currentLunchStart) / (1000 * 60);
            totalLunchTime += lunchMinutes;
            currentLunchStart = null;
          } else if (record.type === 'exit' && currentEntry) {
            const totalMinutes = (time - currentEntry) / (1000 * 60);
            const workedMinutes = totalMinutes - totalLunchTime;
            const hours = workedMinutes / 60;
            totalHours += hours;
            
            if (hours > 9) {
              extraHours += (hours - 9);
            }
            
            currentEntry = null;
            totalLunchTime = 0;
          }
        }

        return { 
          totalHours: totalHours.toFixed(2), 
          extraHours: extraHours.toFixed(2),
          lunchTime: (totalLunchTime / 60).toFixed(2)
        };
      };

      const exportToExcel = () => {
        let csv = 'Trabajador,Tipo,Fecha,Hora,Latitud,Longitud,Mapa\n';
        
        records.forEach(record => {
          const date = new Date(record.timestamp);
          const typeText = {
            entry: 'Entrada',
            exit: 'Salida',
            lunch_start: 'Inicio Colaci贸n',
            lunch_end: 'Fin Colaci贸n'
          };
          csv += `${record.workerName},${typeText[record.type]},${date.toLocaleDateString('es-CL')},${date.toLocaleTimeString('es-CL')},${record.location?.lat || 'N/A'},${record.location?.lng || 'N/A'},${record.location ? `https://maps.google.com/?q=${record.location.lat},${record.location.lng}` : 'N/A'}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `asistencia_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      };

      const startCamera = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' } 
          });
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            setCameraActive(true);
          }
        } catch (error) {
          alert('No se pudo acceder a la c谩mara');
        }
      };

      const stopCamera = () => {
        if (videoRef.current && videoRef.current.srcObject) {
          videoRef.current.srcObject.getTracks().forEach(track => track.stop());
          setCameraActive(false);
        }
      };

      const capturePhoto = () => {
        const canvas = canvasRef.current;
        const video = videoRef.current;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        return canvas.toDataURL('image/jpeg', 0.8);
      };

      const GoogleSheetsConfig = () => {
        const [config, setConfig] = useState(googleConfig);

        const handleSave = async () => {
          if (!config.apiKey || !config.spreadsheetId) {
            alert('Por favor completa todos los campos');
            return;
          }
          await saveConfig({ ...config, configured: true });
          alert('Configuraci贸n guardada exitosamente');
          setActiveView('dashboard');
        };

        return (
          <div className="bg-white rounded-lg shadow-lg p-6 max-w-2xl mx-auto">
            <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
              <Icons.Settings />
              Configuraci贸n Google Sheets
            </h2>

            <div className="space-y-6">
              <div className="bg-blue-50 p-4 rounded-lg text-sm">
                <h3 className="font-bold mb-2"> Instrucciones:</h3>
                <ol className="list-decimal list-inside space-y-1">
                  <li>Ve a Google Cloud Console</li>
                  <li>Crea un proyecto y habilita Google Sheets API</li>
                  <li>Crea una clave API</li>
                  <li>Crea hoja "Registros" con encabezados</li>
                  <li>Comparte con permisos de edici贸n p煤blicos</li>
                </ol>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block font-semibold mb-2">API Key:</label>
                  <input
                    type="password"
                    placeholder="AIzaSy..."
                    className="w-full p-3 border rounded-lg"
                    value={config.apiKey}
                    onChange={(e) => setConfig({...config, apiKey: e.target.value})}
                  />
                </div>

                <div>
                  <label className="block font-semibold mb-2">ID Spreadsheet:</label>
                  <input
                    type="text"
                    placeholder="1BxiMVs0XRA5..."
                    className="w-full p-3 border rounded-lg"
                    value={config.spreadsheetId}
                    onChange={(e) => setConfig({...config, spreadsheetId: e.target.value})}
                  />
                </div>

                <div className="flex gap-2">
                  <button
                    onClick={handleSave}
                    className="flex-1 bg-green-600 text-white p-3 rounded-lg"
                  >
                    Guardar
                  </button>
                  <button
                    onClick={() => setActiveView('dashboard')}
                    className="px-6 bg-gray-300 p-3 rounded-lg"
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const AddWorkerForm = () => {
        const [formData, setFormData] = useState({ name: '', email: '', phone: '' });

        const handleSubmit = async () => {
          if (!formData.name || !formData.email) {
            alert('Completa nombre y email');
            return;
          }
          await addWorker(formData);
          setFormData({ name: '', email: '', phone: '' });
          setActiveView('workers');
        };

        return (
          <div className="bg-white rounded-lg shadow-lg p-6 max-w-md mx-auto">
            <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
              <Icons.UserPlus />
              Nuevo Trabajador
            </h2>
            <div className="space-y-4">
              <input
                type="text"
                placeholder="Nombre completo"
                className="w-full p-3 border rounded-lg"
                value={formData.name}
                onChange={(e) => setFormData({...formData, name: e.target.value})}
              />
              <input
                type="email"
                placeholder="Email"
                className="w-full p-3 border rounded-lg"
                value={formData.email}
                onChange={(e) => setFormData({...formData, email: e.target.value})}
              />
              <input
                type="tel"
                placeholder="Tel茅fono"
                className="w-full p-3 border rounded-lg"
                value={formData.phone}
                onChange={(e) => setFormData({...formData, phone: e.target.value})}
              />
              <button 
                onClick={handleSubmit} 
                className="w-full bg-blue-600 text-white p-3 rounded-lg"
              >
                Agregar Trabajador
              </button>
            </div>
          </div>
        );
      };

      const WorkersList = () => (
        <div className="bg-white rounded-lg shadow-lg p-6">
          <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
            <Icons.Users />
            Trabajadores
          </h2>
          <div className="space-y-4">
            {workers.length === 0 ? (
              <p className="text-gray-500 text-center py-8">No hay trabajadores registrados</p>
            ) : (
              workers.map(worker => {
                const hours = calculateHours(worker.id);
                return (
                  <div key={worker.id} className="border rounded-lg p-4">
                    <div className="flex justify-between items-start">
                      <div>
                        <h3 className="font-bold text-lg">{worker.name}</h3>
                        <p className="text-gray-600 text-sm">{worker.email}</p>
                        <p className="text-sm text-gray-500">QR: {worker.qrCode}</p>
                      </div>
                      <button
                        onClick={() => setSelectedWorker(worker)}
                        className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm"
                      >
                        Ver QR
                      </button>
                    </div>
                    <div className="mt-3 flex gap-3 text-xs flex-wrap">
                      <span className="text-green-600">{hours.totalHours}h trabajadas</span>
                      <span className="text-orange-600">{hours.extraHours}h extras</span>
                      <span className="text-purple-600">{hours.lunchTime}h colaci贸n</span>
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      );

      const QRModal = () => {
        if (!selectedWorker) return null;

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg p-8 max-w-sm w-full relative">
              <button
                onClick={() => setSelectedWorker(null)}
                className="absolute top-4 right-4"
              >
                <Icons.X />
              </button>
              <h3 className="text-xl font-bold mb-4">{selectedWorker.name}</h3>
              <div className="bg-gray-100 p-8 rounded-lg text-center">
                <Icons.QrCode />
                <p className="font-mono text-lg mt-4">{selectedWorker.qrCode}</p>
              </div>
            </div>
          </div>
        );
      };

      const Scanner = () => {
        const [scannedCode, setScannedCode] = useState('');
        const [photo, setPhoto] = useState(null);

        const handleScan = async () => {
          const worker = workers.find(w => w.qrCode === scannedCode);
          if (!worker) {
            alert('C贸digo QR no v谩lido');
            return;
          }

          if (!photo) {
            alert('Debes capturar una foto primero');
            return;
          }

          await registerAttendance(worker.id, scanMode, photo);
          const typeText = {
            entry: 'Entrada',
            exit: 'Salida',
            lunch_start: 'Inicio de Colaci贸n',
            lunch_end: 'Fin de Colaci贸n'
          };
          alert(`${typeText[scanMode]} registrada`);
          setScannedCode('');
          setPhoto(null);
          stopCamera();
          setScanMode(null);
          setActiveView('dashboard');
        };

        useEffect(() => {
          if (scanMode && !cameraActive) {
            startCamera();
          }
          return () => stopCamera();
        }, [scanMode]);

        const typeLabels = {
          entry: 'Entrada',
          exit: 'Salida',
          lunch_start: 'Inicio Colaci贸n',
          lunch_end: 'Fin Colaci贸n'
        };

        const typeIcons = {
          entry: <Icons.LogIn />,
          exit: <Icons.LogOut />,
          lunch_start: <Icons.Coffee />,
          lunch_end: <Icons.Coffee />
        };

        return (
          <div className="bg-white rounded-lg shadow-lg p-6 max-w-md mx-auto">
            <h2 className="text-xl font-bold mb-6 flex items-center gap-2">
              {typeIcons[scanMode]}
              {typeLabels[scanMode]}
            </h2>

            <div className="space-y-4">
              <div className="border-2 border-dashed rounded-lg p-4">
                <video ref={videoRef} autoPlay playsInline className="w-full rounded-lg mb-4" />
                <canvas ref={canvasRef} className="hidden" />
                
                {!photo ? (
                  <button
                    onClick={() => setPhoto(capturePhoto())}
                    className="w-full bg-green-600 text-white px-6 py-2 rounded-lg flex items-center justify-center gap-2"
                  >
                    <Icons.Camera />
                    Capturar Foto
                  </button>
                ) : (
                  <div>
                    <img src={photo} alt="Captura" className="w-full rounded-lg mb-2" />
                    <button
                      onClick={() => setPhoto(null)}
                      className="text-red-600 text-sm"
                    >
                      Tomar otra foto
                    </button>
                  </div>
                )}
              </div>

              <input
                type="text"
                placeholder="C贸digo QR del trabajador"
                className="w-full p-3 border rounded-lg"
                value={scannedCode}
                onChange={(e) => setScannedCode(e.target.value)}
              />

              <button
                onClick={handleScan}
                className="w-full bg-blue-600 text-white p-3 rounded-lg"
              >
                Registrar {typeLabels[scanMode]}
              </button>

              <button
                onClick={() => {
                  setScanMode(null);
                  stopCamera();
                }}
                className="w-full bg-gray-300 p-3 rounded-lg"
              >
                Cancelar
              </button>
            </div>
          </div>
        );
      };

      const Dashboard = () => {
        const todayRecords = records.filter(r => {
          const recordDate = new Date(r.timestamp).toDateString();
          const today = new Date().toDateString();
          return recordDate === today;
        });

        return (
          <div className="space-y-6">
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="bg-blue-500 text-white rounded-lg p-4">
                <Icons.Users />
                <h3 className="text-2xl font-bold mt-2">{workers.length}</h3>
                <p className="text-sm">Trabajadores</p>
              </div>
              <div className="bg-green-500 text-white rounded-lg p-4">
                <Icons.LogIn />
                <h3 className="text-2xl font-bold mt-2">{todayRecords.filter(r => r.type === 'entry').length}</h3>
                <p className="text-sm">Entradas hoy</p>
              </div>
              <div className="bg-orange-500 text-white rounded-lg p-4">
                <Icons.Coffee />
                <h3 className="text-2xl font-bold mt-2">{todayRecords.filter(r => r.type === 'lunch_start').length}</h3>
                <p className="text-sm">En colaci贸n</p>
              </div>
              <div className="bg-purple-500 text-white rounded-lg p-4">
                <Icons.MapPin />
                <h3 className="text-2xl font-bold mt-2">{records.length}</h3>
                <p className="text-sm">Registros</p>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold mb-4">Acciones R谩pidas</h2>
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => setScanMode('lunch_start')}
                  className="bg-orange-600 text-white p-3 rounded-lg flex items-center justify-center gap-2 text-sm"
                >
                  <Icons.Coffee />
                  Inicio Colaci贸n
                </button>
                <button
                  onClick={() => setScanMode('lunch_end')}
                  className="bg-yellow-600 text-white p-3 rounded-lg flex items-center justify-center gap-2 text-sm"
                >
                  <Icons.Coffee />
                  Fin Colaci贸n
                </button>
                <button
                  onClick={() => setScanMode('exit')}
                  className="bg-red-600 text-white p-3 rounded-lg flex items-center justify-center gap-2 text-sm"
                >
                  <Icons.LogOut />
                  Salida
                </button>
                <button
                  onClick={() => setActiveView('addWorker')}
                  className="bg-blue-600 text-white p-3 rounded-lg flex items-center justify-center gap-2 text-sm"
                >
                  <Icons.UserPlus />
                  Nuevo
                </button>
                <button
                  onClick={exportToExcel}
                  className="bg-purple-600 text-white p-3 rounded-lg flex items-center justify-center gap-2 text-sm"
                >
                  <Icons.Download />
                  Exportar
                </button>
              </div>
            </div>

            {!googleConfig.configured && (
              <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                <div className="flex items-center justify-between">
                  <p className="text-yellow-800 font-semibold text-sm">Google Sheets no configurado</p>
                  <button
                    onClick={() => setActiveView('config')}
                    className="bg-yellow-600 text-white px-4 py-2 rounded text-sm"
                  >
                    Configurar
                  </button>
                </div>
              </div>
            )}

            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold mb-4">Registros Recientes</h2>
              <div className="space-y-2 max-h-96 overflow-y-auto">
                {records.length === 0 ? (
                  <p className="text-gray-500 text-center py-8">No hay registros a煤n</p>
                ) : (
                  records.slice(-15).reverse().map(record => {
                    const typeColors = {
                      entry: 'border-green-500 text-green-600',
                      exit: 'border-red-500 text-red-600',
                      lunch_start: 'border-orange-500 text-orange-600',
                      lunch_end: 'border-yellow-500 text-yellow-600'
                    };
                    
                    const typeEmojis = {
                      entry: 'Entrada',
                      exit: 'Salida',
                      lunch_start: 'Inicio Colaci贸n',
                      lunch_end: 'Fin Colaci贸n'
                    };

                    return (
                      <div key={record.id} className={`border-l-4 ${typeColors[record.type].split(' ')[0]} pl-4 py-2`}>
                        <div className="flex justify-between">
                          <span className="font-semibold text-sm">{record.workerName}</span>
                          <span className={`${typeColors[record.type].split(' ')[1]} text-sm`}>
                            {typeEmojis[record.type]}
                          </span>
                        </div>
                        <div className="text-xs text-gray-600">
                          {new Date(record.timestamp).toLocaleString('es-CL')}
                          {record.location && (
                            <a 
                              href={`https://maps.google.com/?q=${record.location.lat},${record.location.lng}`}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="ml-2 text-blue-600"
                            >
                              Ver mapa
                            </a>
                          )}
                        </div>
                      </div>
                    );
                  })
                )}
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-gray-100">
          <nav className="bg-blue-600 text-white p-4 shadow-lg">
            <div className="container mx-auto flex justify-between items-center">
              <h1 className="text-lg md:text-xl font-bold flex items-center gap-2">
                <Icons.QrCode />
                Sistema Asistencia QR
              </h1>
              <div className="flex gap-2">
                <button
                  onClick={() => setActiveView('dashboard')}
                  className="px-3 py-2 rounded hover:bg-blue-700 text-sm"
                >
                  Inicio
                </button>
                <button
                  onClick={() => setActiveView('workers')}
                  className="px-3 py-2 rounded hover:bg-blue-700 text-sm"
                >
                  Trabajadores
                </button>
                <button
                  onClick={() => setActiveView('config')}
                  className="px-3 py-2 rounded hover:bg-blue-700"
                >
                  <Icons.Settings />
                </button>
              </div>
            </div>
          </nav>

          <div className="container mx-auto p-4 md:p-6">
            {scanMode ? (
              <Scanner />
            ) : activeView === 'dashboard' ? (
              <Dashboard />
            ) : activeView === 'workers' ? (
              <WorkersList />
            ) : activeView === 'addWorker' ? (
              <AddWorkerForm />
            ) : activeView === 'config' ? (
              <GoogleSheetsConfig />
            ) : null}
          </div>

          {selectedWorker && <QRModal />}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>={() => setScanMode('entry')}
                  className="bg-green-600 text-white p-3 rounded-lg flex items-center justify-center gap-2 text-sm"
                >
                  <Icons.LogIn />
                  Entrada
                </button>
                <button
                  onClick